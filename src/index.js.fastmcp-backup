#!/usr/bin/env node

import { FastMCP } from "fastmcp";
import { z } from "zod";
import { MiriDevStatusTool } from "./tools/status.js";
import { MiriDevDeployTool } from "./tools/deploy.js";
import { MiriDevAuthTool } from "./tools/auth.js";

// MCP ì„œë²„ ìƒì„±
const server = new FastMCP({
  name: "miridev-mcp",
  version: "1.0.22",
  instructions: `
miri.dev MCP ì„œë²„ëŠ” ìžì—°ì–´ë¥¼ í†µí•´ ì›¹ì‚¬ì´íŠ¸ë¥¼ ë°°í¬í•  ìˆ˜ ìžˆëŠ” ë„êµ¬ìž…ë‹ˆë‹¤.

ì£¼ìš” ê¸°ëŠ¥:
1. ì›¹ì‚¬ì´íŠ¸ ë°°í¬ - ë¡œì»¬ íŒŒì¼ì„ miri.devì— ìžë™ ë°°í¬ (ë¡œê·¸ì¸ ë¶ˆí•„ìš”, 1ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°)
2. ì¸ì¦ ê´€ë¦¬ - ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë° ìƒíƒœ í™•ì¸  (ë¡œê·¸ì¸í›„ 1ì¼ ë¯¸ë¦¬ë³´ê¸° x 50ê°œ ì‚¬ì´íŠ¸ ì œê³µ)
3. ë°°í¬ ëª¨ë‹ˆí„°ë§ - ë°°í¬ ê¸°ë¡ ë° ì‚¬ì´íŠ¸ ëª©ë¡ í™•ì¸ (ì ‘ì†ìž í†µê³„ BETA)

ì‚¬ìš© ì˜ˆì‹œ:
- "í™ˆíŽ˜ì´ì§€ë¥¼ miri.devì— ë°°í¬í•´ì¤˜"
- "ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì¤˜"
- "ìµœê·¼ ë°°í¬í•œ ì‚¬ì´íŠ¸ ëª©ë¡ì„ ë³´ì—¬ì¤˜"

ë°°í¬í•˜ë ¤ë©´ í”„ë¡œì íŠ¸ í´ë”ì— index.html íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.
`,
});

// ë„êµ¬ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const statusTool = new MiriDevStatusTool();
const deployTool = new MiriDevDeployTool();
const authTool = new MiriDevAuthTool();

// ðŸ› ï¸ ì›¹ì‚¬ì´íŠ¸ ë°°í¬ ë„êµ¬ (ì‹¤ì œ ë°°í¬ ìˆ˜í–‰)
server.addTool({
  name: "deploy_website",
  description: "Deploy a website to miri.dev using REAL deployment API (no login required)",
  parameters: z.object({
    message: z.string().describe("Natural language deployment request (e.g., 'í™ˆíŽ˜ì´ì§€ë¥¼ miri.devì— ë°°í¬í•˜ë¼')"),
    projectPath: z.string().optional().default(".").describe("Path to the project directory containing files to deploy"),
    siteName: z.string().optional().describe("Optional site name for the deployment")
  }),
  execute: async (args) => {
    try {
      const { message, projectPath = ".", siteName } = args;
      
      // ì‹¤ì œ ë°°í¬ ë„êµ¬ ì‚¬ìš©
      const result = await deployTool.deploy(projectPath, siteName);
      
      if (result.success) {
        // ë°°í¬ ì„±ê³µ ì‹œ ìƒíƒœ ì €ìž¥
        if (result.siteId && result.url) {
          await statusTool.saveDeploymentStatus({
            url: result.url,
            siteId: result.siteId,
            fileCount: result.fileCount
          });
        }
        
        // ì‚¬ì´íŠ¸ íƒ€ì´í‹€ ê²°ì • (APIì—ì„œ ì œê³µí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
        const siteTitle = result.title || "Untitled Site";
        
        return `ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.
ì‚¬ì´íŠ¸ íƒ€ì´í‹€ : "${siteTitle}"
${result.url}`;
      } else {
        return `âŒ ì‹¤ì œ ë°°í¬ ì‹¤íŒ¨: ${result.error}

ìš”ì²­: ${message}
í”„ë¡œì íŠ¸ ê²½ë¡œ: ${projectPath}`;
      }
    } catch (error) {
      return `âŒ ì‹¤ì œ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
    }
  }
});

// ðŸ” ì¸ì¦ ìƒíƒœ í™•ì¸ ë„êµ¬ (ì‹¤ì œ API ì‚¬ìš©)
server.addTool({
  name: "check_auth_status", 
  description: "Check REAL authentication status with miri.dev API",
  parameters: z.object({}),
  execute: async (args) => {
    try {
      // ì‹¤ì œ ì¸ì¦ ìƒíƒœ í™•ì¸
      const result = await authTool.getDetailedStatus();
      
      return `ðŸ” ì‹¤ì œ ì¸ì¦ ìƒíƒœ

${result.details}

ê¸°ë³¸ ë°°í¬ëŠ” ë¡œê·¸ì¸ ì—†ì´ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤!
ê³ ê¸‰ ê¸°ëŠ¥ì„ ì›í•˜ì‹œë©´ login_miridev ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.`;
    } catch (error) {
      return `âŒ ì‹¤ì œ ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜: ${error.message}

ê¸°ë³¸ ë°°í¬ëŠ” ê³„ì† ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!`;
    }
  }
});

// ðŸ”‘ ë¡œê·¸ì¸ ë„êµ¬ (ì‹¤ì œ ë¡œê·¸ì¸)
server.addTool({
  name: "login_miridev",
  description: "Login to miri.dev account using REAL authentication API",
  parameters: z.object({
    force: z.boolean().optional().default(false).describe("Force re-login even if already authenticated"),
    email: z.string().optional().describe("Email address for login"),
    password: z.string().optional().describe("Password for login")
  }),
  execute: async (args) => {
    try {
      const { force = false, email, password } = args;
      
      if (email && password) {
        // ì‹¤ì œ ë¡œê·¸ì¸ ì‹œë„
        // Note: ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë³´ì•ˆìƒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¡œê·¸ì— ë‚¨ê¸°ì§€ ì•ŠìŠµë‹ˆë‹¤
        return `ðŸ” ì‹¤ì œ ë¡œê·¸ì¸ ê¸°ëŠ¥ì€ ë³´ì•ˆìƒ ëŒ€í™”í˜• ëª¨ë“œì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.

CLIì—ì„œ ë¡œê·¸ì¸í•˜ì„¸ìš”:
$ cd /Users/martin/Claude/www.miri.dev/mcp
$ node bin/miri-mcp.cjs login
`;
      } else {
        // ê¸°ì¡´ ì¸ì¦ ìƒíƒœ í™•ì¸
        const isAuthenticated = await authTool.checkAuthStatus();
        
        if (isAuthenticated && !force) {
          const currentUser = await authTool.getCurrentUser();
          return `âœ… ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìžˆìŠµë‹ˆë‹¤.

ì‚¬ìš©ìž: ${currentUser?.name} (${currentUser?.email})
í”Œëžœ: ${currentUser?.plan}`;
        } else {
          return `ðŸ” ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.

CLIì—ì„œ ëŒ€í™”í˜• ë¡œê·¸ì¸:
$ cd /Users/martin/Claude/www.miri.dev/mcp
$ node bin/miri-mcp.cjs login
`;
        }
      }
    } catch (error) {
      return `âŒ ì‹¤ì œ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}

ê¸°ë³¸ ë°°í¬ëŠ” ê³„ì† ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!`;
    }
  }
});

// ðŸ“Š ë°°í¬ ìƒíƒœ í™•ì¸ ë„êµ¬ (ì‹¤ì œ ë°ì´í„° ì‚¬ìš©)
server.addTool({
  name: "get_deployment_status",
  description: "Get REAL deployment status and site information from miri.dev API", 
  parameters: z.object({}),
  execute: async (args) => {
    try {
      // ì‹¤ì œ ìƒíƒœ í™•ì¸ ë„êµ¬ ì‚¬ìš©
      const result = await statusTool.getStatus();
      
      if (result.success) {
        return `ðŸ“Š ì‹¤ì œ ë°°í¬ ìƒíƒœ í™•ì¸\n\n${result.message}`;
      } else {
        return `âŒ ì‹¤ì œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${result.message}`;
      }
    } catch (error) {
      return `âŒ ì‹¤ì œ ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
    }
  }
});

// ðŸŽ¯ ë°°í¬ ê°€ì´ë“œ í”„ë¡¬í”„íŠ¸
server.addPrompt({
  name: "deployment-guide",
  description: "Get step-by-step deployment guide for miri.dev",
  arguments: [
    {
      name: "project_type",
      description: "Type of project to deploy (html, react, vue, etc.)",
      required: false
    }
  ],
  load: async (args) => {
    const projectType = args?.project_type || "html";
    
    let guide = `# ðŸš€ miri.dev ë°°í¬ ê°€ì´ë“œ (ë¡œê·¸ì¸ ë¶ˆí•„ìš”)\n\n`;
    
    switch (projectType.toLowerCase()) {
      case "react":
        guide += `## React í”„ë¡œì íŠ¸ ë°°í¬\n\n`;
        guide += `1. ë¹Œë“œ ìƒì„±:\n   \`npm run build\`\n\n`;
        guide += `2. ë°°í¬ ì‹¤í–‰:\n   \`deploy_website\` ë„êµ¬ ì‚¬ìš©\n   - message: "React ì•±ì„ ë°°í¬í•˜ë¼"\n   - projectPath: "./build"\n\n`;
        break;
        
      case "vue":
        guide += `## Vue í”„ë¡œì íŠ¸ ë°°í¬\n\n`;
        guide += `1. ë¹Œë“œ ìƒì„±:\n   \`npm run build\`\n\n`;
        guide += `2. ë°°í¬ ì‹¤í–‰:\n   \`deploy_website\` ë„êµ¬ ì‚¬ìš©\n   - message: "Vue ì•±ì„ ë°°í¬í•˜ë¼"\n   - projectPath: "./dist"\n\n`;
        break;
        
      default:
        guide += `## ê¸°ë³¸ HTML í”„ë¡œì íŠ¸ ë°°í¬\n\n`;
        guide += `1. í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸:\n   - index.html (í•„ìˆ˜)\n   - style.css (ì„ íƒ)\n   - script.js (ì„ íƒ)\n   - images/ (ì„ íƒ)\n\n`;
        guide += `2. ë°°í¬ ì‹¤í–‰:\n   \`deploy_website\` ë„êµ¬ ì‚¬ìš©\n   - message: "í™ˆíŽ˜ì´ì§€ë¥¼ ë°°í¬í•˜ë¼"\n\n`;
    }
    
    guide += `## ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ê°„ì†Œí™”)\n\n`;
    guide += `âœ… index.html íŒŒì¼ ì¡´ìž¬ í™•ì¸\n`;
    guide += `âœ… íŒŒì¼ í¬ê¸° 25MB ì´í•˜ í™•ì¸\n`;
    guide += `âœ… í•œê¸€/íŠ¹ìˆ˜ë¬¸ìž íŒŒì¼ëª… ìžë™ ë³€í™˜ë¨\n`;
    guide += `ðŸ”“ ë¡œê·¸ì¸ ë¶ˆí•„ìš”! ë°”ë¡œ ë°°í¬ ê°€ëŠ¥\n\n`;
    guide += `## ë¬¸ì œ í•´ê²°\n\n`;
    guide += `- ë°°í¬ ìƒíƒœ í™•ì¸: \`get_deployment_status\` ë„êµ¬ ì‚¬ìš©\n`;
    guide += `- ë¡œê·¸ì¸ (ì„ íƒ): \`login_miridev\` ë„êµ¬ ì‚¬ìš©\n`;
    guide += `- ê°€ì´ë“œ í™•ì¸: \`deployment-guide\` í”„ë¡¬í”„íŠ¸ ì‚¬ìš©\n`;
    
    return {
      messages: [
        {
          role: "user",
          content: {
            type: "text",
            text: guide
          }
        }
      ]
    };
  }
});

// ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
let connectionAttempts = 0
const maxConnectionAttempts = 3

server.on('connection', () => {
  console.error('[MCP Server] í´ë¼ì´ì–¸íŠ¸ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.')
  connectionAttempts = 0
})

server.on('disconnection', () => {
  console.error('[MCP Server] í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.')
})

server.on('error', (error) => {
  console.error('[MCP Server] ì„œë²„ ì˜¤ë¥˜:', error.message)
  connectionAttempts++
  
  if (connectionAttempts >= maxConnectionAttempts) {
    console.error('[MCP Server] ìµœëŒ€ ì—°ê²° ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.')
    process.exit(1)
  }
})

// Unhandled rejection ì²˜ë¦¬
process.on('unhandledRejection', (reason, promise) => {
  console.error('[MCP Server] Unhandled Rejection:', reason)
})

process.on('uncaughtException', (error) => {
  console.error('[MCP Server] Uncaught Exception:', error.message)
  process.exit(1)
})

// ì„œë²„ ì‹œìž‘
server.start()
  .then(() => {
    // ì„±ê³µì ìœ¼ë¡œ ì‹œìž‘ëœ ê²½ìš° stderrë¡œ ë¡œê·¸ ì¶œë ¥ (JSON-RPC ë°©í•´í•˜ì§€ ì•ŠìŒ)
    console.error('[MCP Server] miridev-mcp v1.0.22 ì„œë²„ê°€ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤.')
    console.error('[MCP Server] Claude Desktopê³¼ ì—°ê²° ëŒ€ê¸° ì¤‘...')
  })
  .catch(error => {
    console.error('[MCP Server] ì„œë²„ ì‹œìž‘ ì˜¤ë¥˜:', error.message)
    process.exit(1)
  })

// í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œ ì •ë¦¬
process.on('SIGINT', () => {
  console.error('[MCP Server] ì„œë²„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤...')
  server.stop()
    .then(() => process.exit(0))
    .catch(() => process.exit(1))
})

process.on('SIGTERM', () => {
  console.error('[MCP Server] ì„œë²„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤...')
  server.stop()
    .then(() => process.exit(0))
    .catch(() => process.exit(1))
}) 